<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sverigekarta med Highcharts och folkm√§ngds-data</title>
  <script src="https://code.highcharts.com/maps/highmaps.js"></script>
  <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/mapdata/countries/se/se-all.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <style>
    #container {
      height: 90vh;
      margin: 0 auto;
    }
    .slider-container {
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div id="container"></div>

  <div class="slider-container">
    <label for="yearSlider">V√§lj √•r:</label>
    <input type="range" id="yearSlider" min="2000" max="2024" value="2024">
    <span id="yearValue">2024</span>
    <br><br>
    <!-- Knapp f√∂r att spara m√§tdata till fil -->
    <button onclick="saveInitialMeasurements()">Spara initiala m√§tningar</button>
    <button onclick="saveUpdateMeasurements()">Spara uppdateringar</button>
    <button onclick="startFullPageReloadMeasurements()">Starta 50 sidladdningar</button>
    <button onclick="simulate50UpdateMeasurements()">Starta 50 uppdateringar</button>
  </div>

  <script>
    let scbData;
let updateStartTime = null; // üîÑ F√∂r uppdateringsm√§tning fr√•n sliders

    const initialMeasurements = JSON.parse(localStorage.getItem('initialMeasurements') || '[]');
    const updateMeasurements = [];

    const reloadCount = Number(localStorage.getItem('reloadCount') || 0);
    const maxReloads = 50;

    const isAutoReload = localStorage.getItem('autoReload') === 'true';

    fetch('scb.json')
      .then(res => res.json())
      .then(scb => {
        scbData = scb;

        renderMap("2024", true);

        document.getElementById("yearSlider").addEventListener("input", function () {
          const year = this.value;
          document.getElementById("yearValue").textContent = year;
          updateStartTime = performance.now();
          renderMap(year);
        });
      });

    function renderMap(year, isInitial = false) {
      const t0 = isInitial ? performance.now() : (updateStartTime || performance.now());

      const selectedKey = year + "M12";
      const timeIndex = scbData.dataset.dimension.Tid.category.index[selectedKey];
      const regionLabels = scbData.dataset.dimension.Region.category.label;
      const regionIndexMap = scbData.dataset.dimension.Region.category.index;
      const totalMonths = Object.keys(scbData.dataset.dimension.Tid.category.index).length;
      const values = scbData.dataset.value;

      const data = Object.keys(regionLabels)
        .map(code => {
          const name = regionLabels[code];
          const regionIndex = regionIndexMap[code];
          const valueIndex = regionIndex * totalMonths + timeIndex;
          const key = getHcKeyFromName(name);
          const value = values[valueIndex];

          return {
            'hc-key': key,
            value
          };
        })
        .filter(item => item['hc-key'] !== null && typeof item.value === 'number');

      Highcharts.mapChart('container', {
        chart: {
          map: 'countries/se/se-all',
          events: {
            load: function () {
              const t1 = performance.now();
              const time = Math.round(t1 - t0);
              if (isInitial) {
                console.log('Initial rendering tog ' + time + ' millisekunder');
                initialMeasurements.push(`initial,${year},${time}`);
                localStorage.setItem('initialMeasurements', JSON.stringify(initialMeasurements));

                if (isAutoReload && reloadCount < maxReloads - 1) {
                  localStorage.setItem('reloadCount', reloadCount + 1);
                  location.reload();
                } else if (isAutoReload && reloadCount >= maxReloads - 1) {
                  localStorage.setItem('autoReload', 'false');
                  localStorage.setItem('reloadCount', '0');
                  alert("50 m√§tningar klara. Klicka p√• 'Spara initiala m√§tningar' f√∂r att ladda ned.");
                }
              } else {
                console.log('Uppdatering f√∂r ' + year + ' tog ' + time + ' millisekunder');
                updateMeasurements.push(`uppdatering,${year},${time}`);
              }
            }
          }
        },
        title: {
          text: `Sverigekarta ‚Äì Befolkning per l√§n (${selectedKey})`
        },
        colorAxis: {
          min: 0,
          max: 2500000,
          stops: [
            [0, '#e0f3f8'],
            [0.5, '#74add1'],
            [1, '#313695']
          ]
        },
        accessibility: {
          enabled: false
        },
        series: [{
          type: 'map',
          joinBy: 'hc-key',
          keys: ['hc-key', 'value'],
          data: data,
          name: 'Befolkning',
          borderColor: '#8a8a8a',
          borderWidth: 1,
          states: {
            hover: {
              color: '#a4edba'
            }
          },
          dataLabels: {
            enabled: false
          },
          tooltip: {
            pointFormat: '{point.name}: <b>{point.value:,0f}</b>'
          }
        }]
      });
    }

    function saveInitialMeasurements() {
      const blob = new Blob(["typ,√•r,tid_ms\n" + initialMeasurements.join("\n")], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'initial_mattider.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function saveUpdateMeasurements() {
      const blob = new Blob(["typ,√•r,tid_ms\n" + updateMeasurements.join("\n")], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'uppdatering_mattider.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function startFullPageReloadMeasurements() {
      localStorage.setItem('autoReload', 'true');
      localStorage.setItem('reloadCount', '0');
      localStorage.setItem('initialMeasurements', '[]');
      location.reload();
    }

    function simulate50UpdateMeasurements() {
      const slider = document.getElementById("yearSlider");
      let count = 0;
      const years = [];

      for (let i = 0; i < 2; i++) {
        for (let year = 2000; year <= 2024; year++) {
          years.push(year);
          if (years.length === 50) break;
        }
      }

      function next() {
        if (count >= 50) {
          console.log("50 uppdateringsm√§tningar klara. Klicka p√• 'Spara uppdateringar' f√∂r att ladda ned.");
          return;
        }

        const year = years[count];
        slider.value = year;
        slider.dispatchEvent(new Event("input"));

        count++;
        setTimeout(next, 300);
      }

      next();
    }

    function getHcKeyFromName(name) {
      const map = {
        "Stockholms l√§n": "se-st",
        "Uppsala l√§n": "se-up",
        "S√∂dermanlands l√§n": "se-sd",
        "√ñsterg√∂tlands l√§n": "se-og",
        "J√∂nk√∂pings l√§n": "se-jo",
        "Kronobergs l√§n": "se-kr",
        "Kalmar l√§n": "se-ka",
        "Gotlands l√§n": "se-gt",
        "Blekinge l√§n": "se-bl",
        "Sk√•ne l√§n": "se-sn",
        "Hallands l√§n": "se-ha",
        "V√§stra G√∂talands l√§n": "se-vg",
        "V√§rmlands l√§n": "se-vr",
        "√ñrebro l√§n": "se-or",
        "V√§stmanlands l√§n": "se-vm",
        "Dalarnas l√§n": "se-ko",
        "G√§vleborgs l√§n": "se-gv",
        "V√§sternorrlands l√§n": "se-vn",
        "J√§mtlands l√§n": "se-ja",
        "V√§sterbottens l√§n": "se-vb",
        "Norrbottens l√§n": "se-nb"
      };
      return map[name] || null;
    }
  </script>
</body>
</html>
